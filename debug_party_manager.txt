-- SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local TextChatService = game:GetService("TextChatService")

print("=== PARTY MANAGER SCRIPT LOADED ===")
print("Script Version: 2.0 (Debug)")
print("Current PlaceId: " .. tostring(game.PlaceId))

-- CONFIGURATION
-- MAIN GROUPS (3 total)
local MAIN_GROUP_1 = {
    Leader = {Name = "IlIIllIIllIlIlllIIIl", UserId = 5849012098},
    Member = {Name = "llIlllIllIllIlIlllll", UserId = 5849012197}
}

local MAIN_GROUP_2 = {
    Leader = {Name = "lllllIlIlllIllIIllIl", UserId = 9402840450},
    Member = {Name = "IlllIllIlIlllIlIlIll", UserId = 9402862163}
}

local MAIN_GROUP_3 = {
    Leader = {Name = "IIIIlIlIIlIlIIlIlIIl", UserId = 9402863701},
    Member = {Name = "lllIIlIIllIlIIllIlIl", UserId = 9402850030}
}

-- FARM GROUPS (3 total)
local FARM_GROUP_1 = {
    Leader = {Name = "IIlIIIIlIIllIIllIIIl", UserId = 5849194872},
    Member = {Name = "IIllIIlIIIllIllllIlI", UserId = 5849194882}
}

local FARM_GROUP_2 = {
    Leader = {Name = "pablolookslikecheese", UserId = 3260873018},
    Member = {Name = "IIllIIIIIlIllIllllIl", UserId = 9404548672}
}

local FARM_GROUP_3 = {
    Leader = {Name = "IIlIIlllllIlllIIIlII", UserId = 9404523629},
    Member = {Name = "lIllllIlIllIllIIIlll", UserId = 9404550773}
}

local ALL_ACCOUNTS = {
    -- Main Groups
    5849012098, 5849012197, 9402840450, 9402862163, 9402863701, 9402850030,
    -- Farm Groups
    5849194872, 5849194882, 3260873018, 9404548672, 9404523629, 9404550773
}

-- All main group IDs combined for easier checking
local ALL_MAIN_GROUP_IDS = {
    5849012098, 5849012197, 9402840450, 9402862163, 9402863701, 9402850030
}

local PLACE_MAIN = 14067600077
local PLACE_MATCH = 18637069183
local PLACE_SOULWARS = 116052447681870

local localPlayer = Players.LocalPlayer
print("Local Player: " .. localPlayer.Name .. " (UserId: " .. localPlayer.UserId .. ")")

-- CHARACTER ASSIGNMENTS
local CHARACTER_ASSIGNMENTS = {
    -- Main Group 1
    [5849012098] = "Jay",    -- Main 1 Leader
    [5849012197] = "Sunny",  -- Main 1 Member
    
    -- Main Group 2
    [9402840450] = "Jal",    -- Main 2 Leader
    [9402862163] = "Kalin",  -- Main 2 Member
    
    -- Main Group 3
    [9402863701] = "Jay",    -- Main 3 Leader
    [9402850030] = "Sunny",  -- Main 3 Member
    
    -- Farm Group 1
    [5849194872] = "Jal",    -- Farm 1 Leader
    [5849194882] = "Kalin",  -- Farm 1 Member
    
    -- Farm Group 2
    [3260873018] = "Jay",    -- Farm 2 Leader
    [9404548672] = "Sunny",  -- Farm 2 Member
    
    -- Farm Group 3
    [9404523629] = "Jal",    -- Farm 3 Leader
    [9404550773] = "Kalin",  -- Farm 3 Member
}

-- PARTY CHECKER FUNCTIONS
local function getMembersFrame()
    print("[DEBUG] Getting members frame...")
    local playerGui = localPlayer:FindFirstChild("PlayerGui")
    if not playerGui then 
        print("[DEBUG] PlayerGui not found")
        return nil 
    end
    
    local menu = playerGui:FindFirstChild("Menu")
    if not menu or menu.ClassName ~= "ScreenGui" then 
        print("[DEBUG] Menu not found or wrong class")
        return nil 
    end
    
    local main = menu:FindFirstChild("Main")
    if not main or main.ClassName ~= "CanvasGroup" then 
        print("[DEBUG] Main not found or wrong class")
        return nil 
    end
    
    local sidebar = main:FindFirstChild("Sidebar")
    if not sidebar or sidebar.ClassName ~= "Frame" then 
        print("[DEBUG] Sidebar not found or wrong class")
        return nil 
    end
    
    local party = sidebar:FindFirstChild("Party")
    if not party or party.ClassName ~= "Frame" then 
        print("[DEBUG] Party not found or wrong class")
        return nil 
    end
    
    local members = party:FindFirstChild("Members")
    if not members or members.ClassName ~= "Frame" then 
        print("[DEBUG] Members not found or wrong class")
        return nil 
    end
    
    print("[DEBUG] Successfully found members frame")
    return members
end

local function getPartyMemberIds()
    local membersFrame = getMembersFrame()
    if not membersFrame then return {} end
    
    local memberIds = {}
    for _, child in pairs(membersFrame:GetChildren()) do
        if child.ClassName == "Frame" then
            local userId = tonumber(child.Name)
            if userId then
                table.insert(memberIds, userId)
            end
        end
    end
    
    print("[DEBUG] Party member IDs: " .. table.concat(memberIds, ", "))
    return memberIds
end

local function checkGroupMemberInParty(memberUserId)
    local partyMemberIds = getPartyMemberIds()
    
    for _, id in pairs(partyMemberIds) do
        if id == memberUserId then
            print("[DEBUG] Member " .. memberUserId .. " found in party")
            return true
        end
    end
    
    print("[DEBUG] Member " .. memberUserId .. " NOT in party")
    return false
end

-- UTILITY FUNCTIONS
local function SendChatMessage(message)
    print("[DEBUG] Sending chat message: " .. message)
    -- Check if the new TextChatService is being used
    if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
        -- Send message using the new TextChatService
        local textChannel = TextChatService.TextChannels.RBXGeneral
        textChannel:SendAsync(message)
    else
        -- Send message using the default chat system
        game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents.SayMessageRequest:FireServer(message, "All")
    end
end

local function waitForGameLoaded()
    print("[DEBUG] Waiting for game to load...")
    if not game:IsLoaded() then
        game.Loaded:Wait()
    end
    print("[DEBUG] Game loaded successfully")
end

local function safeTeleport(placeId)
    print("[DEBUG] Attempting to teleport to PlaceId: " .. placeId)
    local attempts = 0
    while true do
        attempts = attempts + 1
        print("[DEBUG] Teleport attempt #" .. attempts)
        
        local success = pcall(function()
            TeleportService:Teleport(placeId, localPlayer)
        end)
        
        if success then 
            print("[DEBUG] Teleport successful!")
            break 
        else
            print("[DEBUG] Teleport failed, retrying in 5 seconds...")
        end
        task.wait(5)
    end
end

local function correctGroupsInServer()
    print("[DEBUG] Checking for correct groups in server...")
    local mainGroupsPresent = {}
    local farmGroupsPresent = {}
    
    -- Check which groups are present
    for _, player in pairs(Players:GetPlayers()) do
        print("[DEBUG] Checking player: " .. player.Name .. " (UserId: " .. player.UserId .. ")")
        
        -- Check Main Groups
        if player.UserId == MAIN_GROUP_1.Leader.UserId or player.UserId == MAIN_GROUP_1.Member.UserId then
            mainGroupsPresent[1] = true
            print("[DEBUG] Main Group 1 member found: " .. player.Name)
        elseif player.UserId == MAIN_GROUP_2.Leader.UserId or player.UserId == MAIN_GROUP_2.Member.UserId then
            mainGroupsPresent[2] = true
            print("[DEBUG] Main Group 2 member found: " .. player.Name)
        elseif player.UserId == MAIN_GROUP_3.Leader.UserId or player.UserId == MAIN_GROUP_3.Member.UserId then
            mainGroupsPresent[3] = true
            print("[DEBUG] Main Group 3 member found: " .. player.Name)
        end
        
        -- Check Farm Groups
        if player.UserId == FARM_GROUP_1.Leader.UserId or player.UserId == FARM_GROUP_1.Member.UserId then
            farmGroupsPresent[1] = true
            print("[DEBUG] Farm Group 1 member found: " .. player.Name)
        elseif player.UserId == FARM_GROUP_2.Leader.UserId or player.UserId == FARM_GROUP_2.Member.UserId then
            farmGroupsPresent[2] = true
            print("[DEBUG] Farm Group 2 member found: " .. player.Name)
        elseif player.UserId == FARM_GROUP_3.Leader.UserId or player.UserId == FARM_GROUP_3.Member.UserId then
            farmGroupsPresent[3] = true
            print("[DEBUG] Farm Group 3 member found: " .. player.Name)
        end
    end
    
    -- Count present groups
    local mainCount = 0
    local farmCount = 0
    for i in pairs(mainGroupsPresent) do 
        mainCount = mainCount + 1 
        print("[DEBUG] Main Group " .. i .. " is present")
    end
    for i in pairs(farmGroupsPresent) do 
        farmCount = farmCount + 1 
        print("[DEBUG] Farm Group " .. i .. " is present")
    end
    
    print("[DEBUG] Total main groups: " .. mainCount .. ", Total farm groups: " .. farmCount)
    
    -- Valid combinations:
    -- 1. At least one main + at least one farm (ANY combination allowed)
    -- 2. All groups present (6 groups total)
    
    if mainCount >= 1 and farmCount >= 1 then
        print("[DEBUG] Valid combination found: " .. mainCount .. " main group(s) + " .. farmCount .. " farm group(s)")
        return true
    end
    
    print("[DEBUG] Invalid group configuration - need at least 1 main and 1 farm group")
    return false
end

local function serverHasOnlySpecifiedAccounts()
    print("[DEBUG] Checking if server has only specified accounts...")
    local specifiedAccountsInServer = {}
    local totalPlayersInServer = 0
    
    -- Count all players and track specified accounts
    for _, player in pairs(Players:GetPlayers()) do
        totalPlayersInServer = totalPlayersInServer + 1
        
        local isSpecified = false
        for _, accountId in pairs(ALL_ACCOUNTS) do
            if player.UserId == accountId then
                specifiedAccountsInServer[accountId] = true
                isSpecified = true
                print("[DEBUG] Specified account found: " .. player.Name .. " (UserId: " .. player.UserId .. ")")
                break
            end
        end
        
        if not isSpecified then
            print("[DEBUG] NON-SPECIFIED account found: " .. player.Name .. " (UserId: " .. player.UserId .. ")")
        end
    end
    
    -- Count how many specified accounts are present
    local specifiedCount = 0
    for _ in pairs(specifiedAccountsInServer) do
        specifiedCount = specifiedCount + 1
    end
    
    print("[DEBUG] Total players: " .. totalPlayersInServer .. ", Specified accounts: " .. specifiedCount)
    
    -- Return true only if all players in server are from the specified accounts
    local result = specifiedCount == totalPlayersInServer and specifiedCount > 0
    print("[DEBUG] Server has only specified accounts: " .. tostring(result))
    return result
end

local function multipleMainGroupsInServer()
    print("[DEBUG] Checking for multiple main groups...")
    local mainGroupsPresent = 0
    
    for _, player in pairs(Players:GetPlayers()) do
        for _, id in pairs(ALL_MAIN_GROUP_IDS) do
            if player.UserId == id then
                mainGroupsPresent = mainGroupsPresent + 1
                print("[DEBUG] Main group member found: " .. player.Name)
                break
            end
        end
    end
    
    local result = mainGroupsPresent > 2
    print("[DEBUG] Main group members count: " .. mainGroupsPresent .. ", Multiple main groups: " .. tostring(result))
    return result
end

local function multipleFarmGroupsInServer()
    print("[DEBUG] Checking for multiple farm groups...")
    local farmGroupsPresent = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player.UserId == FARM_GROUP_1.Leader.UserId or player.UserId == FARM_GROUP_1.Member.UserId then
            farmGroupsPresent[1] = true
            print("[DEBUG] Farm Group 1 member found: " .. player.Name)
        elseif player.UserId == FARM_GROUP_2.Leader.UserId or player.UserId == FARM_GROUP_2.Member.UserId then
            farmGroupsPresent[2] = true
            print("[DEBUG] Farm Group 2 member found: " .. player.Name)
        elseif player.UserId == FARM_GROUP_3.Leader.UserId or player.UserId == FARM_GROUP_3.Member.UserId then
            farmGroupsPresent[3] = true
            print("[DEBUG] Farm Group 3 member found: " .. player.Name)
        end
    end
    
    local farmCount = 0
    for i in pairs(farmGroupsPresent) do 
        farmCount = farmCount + 1 
        print("[DEBUG] Farm Group " .. i .. " is present")
    end
    
    local result = farmCount > 1
    print("[DEBUG] Farm group count: " .. farmCount .. ", Multiple farm groups: " .. tostring(result))
    return result
end

local function waitForRemotesReady()
    print("[DEBUG] Waiting for remotes to be ready...")
    local ready = false
    local attempts = 0
    while not ready and attempts < 60 do
        attempts = attempts + 1
        
        ready = pcall(function()
            ReplicatedStorage:WaitForChild("Remotes", 1)
            ReplicatedStorage.Remotes:WaitForChild("Team", 1)
            return true
        end)
        
        if not ready then 
            print("[DEBUG] Remotes not ready, attempt " .. attempts .. "/60")
            task.wait(1) 
        end
    end
    
    print("[DEBUG] Remotes ready: " .. tostring(ready))
    return ready
end

-- PARTY LEAVE FUNCTION
local function leaveParty()
    print("[DEBUG] Attempting to leave party...")
    local success = pcall(function()
        local args = {"Leave"}
        ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Team"):FireServer(unpack(args))
    end)
    print("[DEBUG] Leave party success: " .. tostring(success))
end

local function leavePartyIfInOne()
    print("[DEBUG] Checking if in party and leaving if needed...")
    -- Wait a bit for remotes to be ready
    local remotesReady = waitForRemotesReady()
    if not remotesReady then
        print("[DEBUG] Remotes not ready, skipping party leave")
        return
    end
    
    -- Check if we're in a party by trying to get party member IDs
    local partyMemberIds = getPartyMemberIds()
    if #partyMemberIds > 1 then -- More than just ourselves means we're in a party
        print("[DEBUG] In a party with " .. #partyMemberIds .. " members, leaving...")
        leaveParty()
        task.wait(2) -- Wait for leave to process
    else
        print("[DEBUG] Not in a party or party check failed")
    end
end

local function inviteAndWaitForMember()
    print("[DEBUG] Starting invite process...")
    local memberToInvite = nil
    
    if localPlayer.Name == MAIN_GROUP_1.Leader.Name then
        memberToInvite = MAIN_GROUP_1.Member
    elseif localPlayer.Name == MAIN_GROUP_2.Leader.Name then
        memberToInvite = MAIN_GROUP_2.Member
    elseif localPlayer.Name == MAIN_GROUP_3.Leader.Name then
        memberToInvite = MAIN_GROUP_3.Member
    elseif localPlayer.Name == FARM_GROUP_1.Leader.Name then
        memberToInvite = FARM_GROUP_1.Member
    elseif localPlayer.Name == FARM_GROUP_2.Leader.Name then
        memberToInvite = FARM_GROUP_2.Member
    elseif localPlayer.Name == FARM_GROUP_3.Leader.Name then
        memberToInvite = FARM_GROUP_3.Member
    end
    
    if not memberToInvite then
        print("[DEBUG] Not a leader - cannot invite")
        return false -- Not a leader
    end
    
    print("[DEBUG] Need to invite: " .. memberToInvite.Name .. " (UserId: " .. memberToInvite.UserId .. ")")
    
    -- Check if member is already in party
    if checkGroupMemberInParty(memberToInvite.UserId) then
        print("[DEBUG] Member already in party!")
        task.wait(2)
        return true
    end
    
    local inviteAttempts = 0
    local maxInviteAttempts = 20
    
    -- Send initial invite
    print("[DEBUG] Sending initial invite...")
    pcall(function()
        local targetPlayer = Players:FindFirstChild(memberToInvite.Name)
        if targetPlayer then
            local args = {"Invite", targetPlayer}
            ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
            print("[DEBUG] Invite sent to " .. targetPlayer.Name)
        else
            print("[DEBUG] Target player not found: " .. memberToInvite.Name)
        end
    end)
    inviteAttempts = inviteAttempts + 1
    
    -- Keep inviting every 3 seconds up to 20 attempts
    while inviteAttempts < maxInviteAttempts do
        task.wait(3)
        
        if checkGroupMemberInParty(memberToInvite.UserId) then
            print("[DEBUG] Member successfully joined party!")
            task.wait(1)
            return true
        end
        
        -- Send invite again
        print("[DEBUG] Sending invite attempt " .. (inviteAttempts + 1) .. "/" .. maxInviteAttempts)
        pcall(function()
            local targetPlayer = Players:FindFirstChild(memberToInvite.Name)
            if targetPlayer then
                local args = {"Invite", targetPlayer}
                ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
            else
                print("[DEBUG] Target player not found: " .. memberToInvite.Name)
            end
        end)
        inviteAttempts = inviteAttempts + 1
    end
    
    print("[DEBUG] Max invite attempts reached - failed to form party")
    return false -- Max attempts reached
end

local function acceptInvites()
    print("[DEBUG] Starting invite acceptance process...")
    local leaderName = nil
    
    if localPlayer.Name == MAIN_GROUP_1.Member.Name then
        leaderName = MAIN_GROUP_1.Leader.Name
    elseif localPlayer.Name == MAIN_GROUP_2.Member.Name then
        leaderName = MAIN_GROUP_2.Leader.Name
    elseif localPlayer.Name == MAIN_GROUP_3.Member.Name then
        leaderName = MAIN_GROUP_3.Leader.Name
    elseif localPlayer.Name == FARM_GROUP_1.Member.Name then
        leaderName = FARM_GROUP_1.Leader.Name
    elseif localPlayer.Name == FARM_GROUP_2.Member.Name then
        leaderName = FARM_GROUP_2.Leader.Name
    elseif localPlayer.Name == FARM_GROUP_3.Member.Name then
        leaderName = FARM_GROUP_3.Leader.Name
    end
    
    if leaderName then
        print("[DEBUG] Looking for leader: " .. leaderName)
        local maxAcceptAttempts = 20
        for i = 1, maxAcceptAttempts do
            print("[DEBUG] Accept invite attempt " .. i .. "/" .. maxAcceptAttempts)
            pcall(function()
                local leaderPlayer = Players:FindFirstChild(leaderName)
                if leaderPlayer then
                    local args = {"AcceptInvite", leaderPlayer}
                    ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
                    print("[DEBUG] Accept invite sent to " .. leaderPlayer.Name)
                else
                    print("[DEBUG] Leader not found: " .. leaderName)
                end
            end)
            
            -- Wait 3 seconds between attempts, except after the last attempt
            if i < maxAcceptAttempts then
                task.wait(3)
            end
        end
    else
        print("[DEBUG] Not a member - cannot accept invites")
    end
end

local function startQueue()
    print("[DEBUG] Starting queue process...")
    
    if localPlayer.UserId == MAIN_GROUP_1.Leader.UserId or 
       localPlayer.UserId == MAIN_GROUP_2.Leader.UserId or
       localPlayer.UserId == MAIN_GROUP_3.Leader.UserId or
       localPlayer.UserId == FARM_GROUP_1.Leader.UserId or
       localPlayer.UserId == FARM_GROUP_2.Leader.UserId or
       localPlayer.UserId == FARM_GROUP_3.Leader.UserId then
        
        print("[DEBUG] I am a leader - starting queue immediately")
        for attempt = 1, 8 do
            print("[DEBUG] Leader queue attempt " .. attempt .. "/8")
            pcall(function()
                local args = {"JoinQueue", "SOUL WARS"}
                ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
            end)
            
            if attempt < 8 then
                task.wait(2)
            end
        end
        
        task.wait(5)
        
        if game.PlaceId == PLACE_MATCH then
            print("[DEBUG] Still in match place, sending additional queue attempts")
            for attempt = 1, 4 do
                print("[DEBUG] Additional queue attempt " .. attempt .. "/4")
                pcall(function()
                    local args = {"JoinQueue", "SOUL WARS"}
                    ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
                end)
                task.wait(3)
            end
        end
        
    elseif isGroupMember() then
        print("[DEBUG] I am a member - waiting 2 seconds then starting queue")
        task.wait(2)
        for attempt = 1, 8 do
            print("[DEBUG] Member queue attempt " .. attempt .. "/8")
            pcall(function()
                local args = {"JoinQueue", "SOUL WARS"}
                ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
            end)
            if attempt < 8 then
                task.wait(2)
            end
        end
    else
        print("[DEBUG] Not a recognized group member - not queuing")
    end
end

local function isGroupMember()
    return localPlayer.UserId == MAIN_GROUP_1.Leader.UserId or
           localPlayer.UserId == MAIN_GROUP_1.Member.UserId or
           localPlayer.UserId == MAIN_GROUP_2.Leader.UserId or
           localPlayer.UserId == MAIN_GROUP_2.Member.UserId or
           localPlayer.UserId == MAIN_GROUP_3.Leader.UserId or
           localPlayer.UserId == MAIN_GROUP_3.Member.UserId or
           localPlayer.UserId == FARM_GROUP_1.Leader.UserId or
           localPlayer.UserId == FARM_GROUP_1.Member.UserId or
           localPlayer.UserId == FARM_GROUP_2.Leader.UserId or
           localPlayer.UserId == FARM_GROUP_2.Member.UserId or
           localPlayer.UserId == FARM_GROUP_3.Leader.UserId or
           localPlayer.UserId == FARM_GROUP_3.Member.UserId
end

local function isMainGroupMember()
    for _, id in pairs(ALL_MAIN_GROUP_IDS) do
        if localPlayer.UserId == id then 
            print("[DEBUG] I am a main group member")
            return true 
        end
    end
    print("[DEBUG] I am NOT a main group member")
    return false
end

local function isFarmGroupMember()
    local result = localPlayer.UserId == FARM_GROUP_1.Leader.UserId or
                  localPlayer.UserId == FARM_GROUP_1.Member.UserId or
                  localPlayer.UserId == FARM_GROUP_2.Leader.UserId or
                  localPlayer.UserId == FARM_GROUP_2.Member.UserId or
                  localPlayer.UserId == FARM_GROUP_3.Leader.UserId or
                  localPlayer.UserId == FARM_GROUP_3.Member.UserId
    
    if result then
        print("[DEBUG] I am a farm group member")
    else
        print("[DEBUG] I am NOT a farm group member")
    end
    return result
end

-- CHARACTER SELECTION FUNCTIONS
local function waitForCharacterSelection()
    print("[DEBUG] Waiting for character selection screen...")
    local playerGui = localPlayer:FindFirstChild("PlayerGui")
    if not playerGui then 
        print("[DEBUG] PlayerGui not found")
        return false 
    end
    
    local intermission = playerGui:FindFirstChild("Intermission")
    if not intermission then 
        print("[DEBUG] Intermission GUI not found")
        return false 
    end
    
    local main = intermission:FindFirstChild("Main")
    if not main then 
        print("[DEBUG] Intermission Main not found")
        return false 
    end
    
    local top = main:FindFirstChild("Top")
    if not top then 
        print("[DEBUG] Intermission Top not found")
        return false 
    end
    
    local title = top:FindFirstChild("Title")
    if not title or title.ClassName ~= "TextLabel" then 
        print("[DEBUG] Title not found or wrong class")
        return false 
    end
    
    -- Wait for the "select your character" text
    local attempts = 0
    while attempts < 60 do
        if title.Text and string.lower(title.Text) == "select your character" then
            print("[DEBUG] Character selection screen found!")
            return true
        end
        print("[DEBUG] Waiting for character selection... Current text: " .. tostring(title.Text))
        task.wait(1)
        attempts = attempts + 1
    end
    
    print("[DEBUG] Character selection screen timeout")
    return false
end

local function selectCharacter()
    local characterToSelect = CHARACTER_ASSIGNMENTS[localPlayer.UserId]
    if not characterToSelect then 
        print("[DEBUG] No character assignment found for UserId: " .. localPlayer.UserId)
        return 
    end
    
    print("[DEBUG] Selecting character: " .. characterToSelect)
    
    -- Try character selection up to 3 times with 5 second delay
    for attempt = 1, 3 do
        print("[DEBUG] Character selection attempt " .. attempt .. "/3")
        pcall(function()
            -- First, hover over character
            local args = {"UpdateHoveringCharacter", characterToSelect}
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Matchmaking"):WaitForChild("ServerAction"):FireServer(unpack(args))
            print("[DEBUG] Hover character sent")
        end)
        
        task.wait(1)
        
        pcall(function()
            -- Then select the character
            local args = {"SelectCharacter", characterToSelect}
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Matchmaking"):WaitForChild("ServerAction"):FireServer(unpack(args))
            print("[DEBUG] Select character sent")
        end)
        
        -- Wait 5 seconds before next attempt (except after last attempt)
        if attempt < 3 then
            task.wait(5)
        end
    end
end

local function resetCharacter()
    print("[DEBUG] Resetting character...")
    if localPlayer.Character and localPlayer.Character:FindFirstChild("Humanoid") then
        localPlayer.Character.Humanoid.Health = 0
        print("[DEBUG] Character reset successful")
    else
        print("[DEBUG] Character or Humanoid not found for reset")
    end
end

local function getMatchInfo()
    local playerGui = localPlayer:FindFirstChild("PlayerGui")
    if not playerGui then return nil, nil end
    
    local match = playerGui:FindFirstChild("Match")
    if not match or match.ClassName ~= "ScreenGui" then return nil, nil end
    
    local main = match:FindFirstChild("Main")
    if not main or main.ClassName ~= "CanvasGroup" then return nil, nil end
    
    local top = main:FindFirstChild("Top")
    if not top or top.ClassName ~= "Frame" then return nil, nil end
    
    local currentRound = top:FindFirstChild("CurrentRound")
    local timer = top:FindFirstChild("Timer")
    
    local roundText = currentRound and currentRound.ClassName == "TextLabel" and currentRound.Text or nil
    local timerText = timer and timer.ClassName == "TextLabel" and timer.Text or nil
    
    return roundText, timerText
end

local function monitorMatch()
    print("[DEBUG] Starting match monitoring...")
    while game.PlaceId == PLACE_SOULWARS do
        local currentRound, timerText = getMatchInfo()
        
        if currentRound and timerText then
            print("[DEBUG] Match Info - Round: " .. currentRound .. ", Timer: " .. timerText)
            
            -- Check if it's Round 6
            if currentRound == "Round 6" then
                print("[DEBUG] Round 6 detected! Waiting 25 seconds then teleporting...")
                task.wait(25)
                safeTeleport(PLACE_MATCH)
                return
            end
            
            -- Check if timer > 100 and not Round 6, reset farm members
            local timerValue = tonumber(timerText)
            if timerValue and timerValue > 100 and currentRound ~= "Round 6" then
                print("[DEBUG] Timer > 100 and not Round 6 (Timer: " .. timerValue .. ")")
                if isFarmGroupMember() then
                    print("[DEBUG] I'm a farm member - resetting character")
                    resetCharacter()
                else
                    print("[DEBUG] I'm not a farm member - no reset needed")
                end
            end
        else
            print("[DEBUG] Could not get match info")
        end
        
        task.wait(1)
    end
    print("[DEBUG] Match monitoring ended (left Soul Wars)")
end

-- MAIN EXECUTION
local function runPartyManager()
    print("[DEBUG] === STARTING PARTY MANAGER ===")
    waitForGameLoaded()
    
    -- Leave any existing party at startup
    if game.PlaceId == PLACE_MATCH then
        print("[DEBUG] In match place - leaving any existing party")
        leavePartyIfInOne()
    end
    
    local matchStartTime = tick()
    
    while true do
        print("[DEBUG] Main loop - Current PlaceId: " .. game.PlaceId)
        
        if game.PlaceId == PLACE_MAIN then
            print("[DEBUG] In main place - teleporting to match")
            safeTeleport(PLACE_MATCH)
            matchStartTime = tick() -- Reset timer on place change
            
        elseif game.PlaceId == PLACE_MATCH then
            print("[DEBUG] In match place - checking server composition")
            
            -- Wait for correct groups to be in server, with timeout
            local waitingForAccounts = true
            while waitingForAccounts do
                local elapsed = tick() - matchStartTime
                print("[DEBUG] Elapsed time: " .. math.floor(elapsed) .. " seconds")
                
                if elapsed > 360 then
                    print("[DEBUG] TIMEOUT! 6 minutes elapsed - going to main place")
                    safeTeleport(PLACE_MAIN)
                    matchStartTime = tick()
                    break
                end
                
                if correctGroupsInServer() then
                    print("[DEBUG] Correct groups found! Proceeding with party formation...")
                    waitingForAccounts = false
                    local remotesReady = waitForRemotesReady()
                    
                    if remotesReady then
                        print("[DEBUG] Remotes ready - starting party process")
                        task.wait(3)
                        
                        -- For leaders: invite and wait for member to join party
                        if localPlayer.UserId == MAIN_GROUP_1.Leader.UserId or
                           localPlayer.UserId == MAIN_GROUP_2.Leader.UserId or
                           localPlayer.UserId == MAIN_GROUP_3.Leader.UserId or
                           localPlayer.UserId == FARM_GROUP_1.Leader.UserId or
                           localPlayer.UserId == FARM_GROUP_2.Leader.UserId or
                           localPlayer.UserId == FARM_GROUP_3.Leader.UserId then
                            
                            print("[DEBUG] I'm a leader - inviting member and starting queue")
                            local partyReady = inviteAndWaitForMember()
                            if partyReady then
                                print("[DEBUG] Party formed successfully - starting queue")
                                startQueue()
                                task.wait(10)
                            else
                                print("[DEBUG] Party formation failed")
                            end
                        else
                            print("[DEBUG] I'm a member - accepting invites and starting queue")
                            -- For members: accept invites
                            acceptInvites()
                            startQueue()
                            task.wait(10)
                        end
                    else
                        print("[DEBUG] Remotes not ready - skipping party process")
                    end
                else
                    print("[DEBUG] Waiting for correct groups... (checking again in 15 seconds)")
                    task.wait(15)
                end
            end
            
        elseif game.PlaceId == PLACE_SOULWARS then
            print("[DEBUG] In Soul Wars - performing security checks")
            
            -- Check if server contains only specified accounts
            if not serverHasOnlySpecifiedAccounts() then
                print("[DEBUG] SECURITY ALERT: Non-specified accounts detected - leaving immediately")
                safeTeleport(PLACE_MATCH)
                matchStartTime = tick()
            -- Check if multiple main groups are in the same Soul Wars match (prevent main vs main)
            elseif multipleMainGroupsInServer() and isMainGroupMember() then
                print("[DEBUG] CONFLICT ALERT: Multiple main groups detected and I'm main - leaving")
                safeTeleport(PLACE_MATCH)
                matchStartTime = tick()
            -- Check if multiple farm groups are in the same Soul Wars match (prevent farm vs farm)
            elseif multipleFarmGroupsInServer() and isFarmGroupMember() then
                print("[DEBUG] CONFLICT ALERT: Multiple farm groups detected and I'm farm - leaving")
                safeTeleport(PLACE_MATCH)
                matchStartTime = tick()
            else
                print("[DEBUG] Security checks passed - proceeding with match")
                
                -- Wait for character selection screen and select character
                if waitForCharacterSelection() then
                    print("[DEBUG] Character selection available - selecting character")
                    task.wait(2) -- Wait a bit before selecting
                    selectCharacter()
                    task.wait(3) -- Wait after selection
                else
                    print("[DEBUG] Character selection not available or timed out")
                end
                
                -- Monitor match progress
                print("[DEBUG] Starting match monitoring")
                monitorMatch()
                matchStartTime = tick()
            end
        else
            print("[DEBUG] Unknown PlaceId: " .. game.PlaceId .. " - waiting...")
        end
        
        task.wait(1)
    end
end

-- START SCRIPT
print("[DEBUG] Spawning main party manager function...")
spawn(runPartyManager)
print("[DEBUG] === PARTY MANAGER SCRIPT FULLY LOADED ===")