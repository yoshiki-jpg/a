-- SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local TextChatService = game:GetService("TextChatService")

-- CONFIGURATION
local MAIN_GROUP = {
    Leader = {Name = "IlIIllIlIIllIlIIIlII", UserId = 5729726646},
    Members = {
        {Name = "lIlIIllIllIlIllIllIl", UserId = 5729724431},
        {Name = "IIllIlIIllIIlIIlIll", UserId = 9323915854},
        {Name = "IlIIIlIlIlIlIlIIllIl", UserId = 5729711908},
    }
}

local FARM_GROUP = {
    Leader = {Name = "lIIllIlIIllIlllIllIl", UserId = 5729713788},
    Members = {
        {Name = "BangBangYT4", UserId = 2011296277},
        {Name = "pablolookslikecheese", UserId = 3260873018},
        {Name = "sqpva", UserId = 3606502638},
    }
}

local ALL_ACCOUNTS = {
    5729726646, 5729724431, 9323915854, 5729711908, 5729713788, 2011296277, 3260873018, 3606502638
}

local PLACE_MAIN = 14067600077
local PLACE_MATCH = 18637069183
local PLACE_CASCADE = 138059541435332

local localPlayer = Players.LocalPlayer

-- DEBUG HELPER
local function debugPrint(message)
    print("[PARTY MANAGER DEBUG] " .. tostring(message))
end

-- PARTY CHECKER FUNCTIONS
local function getMembersFrame()
    local playerGui = localPlayer:FindFirstChild("PlayerGui")
    if not playerGui then 
        debugPrint("PlayerGui not found")
        return nil 
    end
    
    local menu = playerGui:FindFirstChild("Menu")
    if not menu or menu.ClassName ~= "ScreenGui" then 
        debugPrint("Menu ScreenGui not found")
        return nil 
    end
    
    local main = menu:FindFirstChild("Main")
    if not main or main.ClassName ~= "CanvasGroup" then 
        debugPrint("Main CanvasGroup not found")
        return nil 
    end
    
    local sidebar = main:FindFirstChild("Sidebar")
    if not sidebar or sidebar.ClassName ~= "Frame" then 
        debugPrint("Sidebar Frame not found")
        return nil 
    end
    
    local party = sidebar:FindFirstChild("Party")
    if not party or party.ClassName ~= "Frame" then 
        debugPrint("Party Frame not found")
        return nil 
    end
    
    local members = party:FindFirstChild("Members")
    if not members or members.ClassName ~= "Frame" then 
        debugPrint("Members Frame not found")
        return nil 
    end
    
    debugPrint("Successfully found Members frame")
    return members
end

local function getPartyMemberIds()
    local membersFrame = getMembersFrame()
    if not membersFrame then 
        debugPrint("Could not get members frame for party check")
        return {} 
    end
    
    local memberIds = {}
    for _, child in pairs(membersFrame:GetChildren()) do
        if child.ClassName == "Frame" then
            local userId = tonumber(child.Name)
            if userId then
                table.insert(memberIds, userId)
                debugPrint("Found party member: " .. tostring(userId))
            end
        end
    end
    
    debugPrint("Total party members found: " .. #memberIds)
    return memberIds
end

local function checkGroupMembersInParty(groupMembers)
    debugPrint("Checking if group members are in party...")
    local partyMemberIds = getPartyMemberIds()
    local partyMemberSet = {}
    
    -- Convert party member IDs to set for faster lookup
    for _, id in pairs(partyMemberIds) do
        partyMemberSet[id] = true
    end
    
    -- Check if all group members are in party
    for _, member in pairs(groupMembers) do
        if not partyMemberSet[member.UserId] then
            debugPrint("Group member " .. member.Name .. " (" .. member.UserId .. ") not in party")
            return false
        else
            debugPrint("Group member " .. member.Name .. " (" .. member.UserId .. ") is in party")
        end
    end
    
    debugPrint("All group members are in party!")
    return true
end

-- UTILITY FUNCTIONS
local function SendChatMessage(message)
    debugPrint("Sending chat message: " .. message)
    -- Check if the new TextChatService is being used
    if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
        -- Send message using the new TextChatService
        local textChannel = TextChatService.TextChannels.RBXGeneral
        textChannel:SendAsync(message)
    else
        -- Send message using the default chat system
        game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents.SayMessageRequest:FireServer(message, "All")
    end
end

local function waitForGameLoaded()
    debugPrint("Waiting for game to load...")
    if not game:IsLoaded() then
        game.Loaded:Wait()
    end
    debugPrint("Game loaded successfully")
end

local function safeTeleport(placeId)
    debugPrint("Attempting to teleport to place: " .. tostring(placeId))
    local attempts = 0
    while true do
        attempts = attempts + 1
        debugPrint("Teleport attempt #" .. attempts)
        
        local success = pcall(function()
            TeleportService:Teleport(placeId, localPlayer)
        end)
        
        if success then 
            debugPrint("Teleport successful!")
            break 
        else
            debugPrint("Teleport failed, retrying in 5 seconds...")
        end
        task.wait(5)
    end
end

local function allAccountsInServer()
    local count = 0
    local accountsFound = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        for _, accountId in pairs(ALL_ACCOUNTS) do
            if player.UserId == accountId then
                count = count + 1
                table.insert(accountsFound, player.Name .. " (" .. player.UserId .. ")")
                break
            end
        end
    end
    
    debugPrint("Accounts in server (" .. count .. "/" .. #ALL_ACCOUNTS .. "): " .. table.concat(accountsFound, ", "))
    return count == #ALL_ACCOUNTS
end

local function serverHasOnlySpecifiedAccounts()
    local specifiedAccountsInServer = {}
    local totalPlayersInServer = 0
    local allPlayersInServer = {}
    
    -- Count all players and track specified accounts
    for _, player in pairs(Players:GetPlayers()) do
        totalPlayersInServer = totalPlayersInServer + 1
        table.insert(allPlayersInServer, player.Name .. " (" .. player.UserId .. ")")
        
        for _, accountId in pairs(ALL_ACCOUNTS) do
            if player.UserId == accountId then
                specifiedAccountsInServer[accountId] = true
                break
            end
        end
    end
    
    -- Count how many specified accounts are present
    local specifiedCount = 0
    for _ in pairs(specifiedAccountsInServer) do
        specifiedCount = specifiedCount + 1
    end
    
    debugPrint("All players in server: " .. table.concat(allPlayersInServer, ", "))
    debugPrint("Specified accounts in server: " .. specifiedCount .. "/" .. totalPlayersInServer)
    
    local result = specifiedCount == totalPlayersInServer and specifiedCount > 0
    debugPrint("Server has only specified accounts: " .. tostring(result))
    return result
end

local function isLeaderInServer()
    for _, player in pairs(Players:GetPlayers()) do
        if player.UserId == MAIN_GROUP.Leader.UserId then
            debugPrint("Main group leader found in server: " .. player.Name)
            return true
        elseif player.UserId == FARM_GROUP.Leader.UserId then
            debugPrint("Farm group leader found in server: " .. player.Name)
            return true
        end
    end
    debugPrint("No leaders found in server")
    return false
end

local function tryJoinLeaderServer()
    debugPrint("Attempting to join leader server...")
    
    -- Only attempt if current player is a member (not a leader)
    if localPlayer.UserId == MAIN_GROUP.Leader.UserId or localPlayer.UserId == FARM_GROUP.Leader.UserId then
        debugPrint("Current player is a leader, no need to join")
        return -- Leaders don't need to join themselves
    end
    
    -- Check if this player belongs to any group
    local belongsToGroup = false
    for _, member in pairs(MAIN_GROUP.Members) do
        if localPlayer.UserId == member.UserId then
            belongsToGroup = true
            debugPrint("Player belongs to main group")
            break
        end
    end
    if not belongsToGroup then
        for _, member in pairs(FARM_GROUP.Members) do
            if localPlayer.UserId == member.UserId then
                belongsToGroup = true
                debugPrint("Player belongs to farm group")
                break
            end
        end
    end
    
    if not belongsToGroup then
        debugPrint("Player does not belong to any group, skipping join attempt")
        return -- Only group members should try to join leaders
    end
    
    -- Try main leader twice with 20 second delay
    for attempt = 1, 2 do
        debugPrint("Join leader attempt " .. attempt .. "/2")
        pcall(function()
            SendChatMessage("!joinserver " .. MAIN_GROUP.Leader.Name)
        end)
        
        if attempt < 2 then
            debugPrint("Waiting 20 seconds before next attempt...")
            task.wait(20)
        end
    end
end

local function waitForRemotesReady()
    debugPrint("Waiting for remotes to be ready...")
    local ready = false
    local attempts = 0
    while not ready and attempts < 60 do
        attempts = attempts + 1
        debugPrint("Remote check attempt " .. attempts .. "/60")
        
        ready = pcall(function()
            ReplicatedStorage:WaitForChild("Remotes", 1)
            ReplicatedStorage.Remotes:WaitForChild("Team", 1)
            return true
        end)
        
        if not ready then 
            task.wait(1) 
        end
    end
    
    if ready then
        debugPrint("Remotes are ready!")
    else
        debugPrint("Remotes failed to load after 60 attempts")
    end
    
    return ready
end

local function inviteAndWaitForMembers()
    if localPlayer.Name == MAIN_GROUP.Leader.Name then
        debugPrint("Main group leader inviting members...")
        
        -- Check if party is already complete (only check own group members)
        if checkGroupMembersInParty(MAIN_GROUP.Members) then
            debugPrint("Party already complete for main group")
            task.wait(2)
            return true
        end
        
        local inviteAttempts = 0
        local maxInviteAttempts = 6
        
        -- Send initial invites to main group members
        debugPrint("Sending initial invites to main group members...")
        for _, member in pairs(MAIN_GROUP.Members) do
            pcall(function()
                local targetPlayer = Players:FindFirstChild(member.Name)
                if targetPlayer then
                    debugPrint("Inviting " .. member.Name .. " to party")
                    local args = {"Invite", targetPlayer}
                    ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
                else
                    debugPrint("Could not find " .. member.Name .. " in server")
                end
            end)
        end
        inviteAttempts = inviteAttempts + 1
        
        -- Keep inviting every 3 seconds up to 6 attempts
        while inviteAttempts < maxInviteAttempts do
            debugPrint("Waiting 3 seconds before checking party status...")
            task.wait(3)
            
            if checkGroupMembersInParty(MAIN_GROUP.Members) then
                debugPrint("All main group members joined party successfully!")
                task.wait(1)
                return true
            end
            
            debugPrint("Not all members in party yet, sending invites again... (attempt " .. (inviteAttempts + 1) .. "/" .. maxInviteAttempts .. ")")
            -- Send invites again
            for _, member in pairs(MAIN_GROUP.Members) do
                pcall(function()
                    local targetPlayer = Players:FindFirstChild(member.Name)
                    if targetPlayer then
                        local args = {"Invite", targetPlayer}
                        ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
                    end
                end)
            end
            inviteAttempts = inviteAttempts + 1
        end
        
        debugPrint("Max invite attempts reached for main group")
        return false -- Max attempts reached
        
    elseif localPlayer.Name == FARM_GROUP.Leader.Name then
        debugPrint("Farm group leader inviting members...")
        
        -- Check if party is already complete (only check own group members)
        if checkGroupMembersInParty(FARM_GROUP.Members) then
            debugPrint("Party already complete for farm group")
            task.wait(2)
            return true
        end
        
        local inviteAttempts = 0
        local maxInviteAttempts = 6
        
        -- Send initial invites to farm group members
        debugPrint("Sending initial invites to farm group members...")
        for _, member in pairs(FARM_GROUP.Members) do
            pcall(function()
                local targetPlayer = Players:FindFirstChild(member.Name)
                if targetPlayer then
                    debugPrint("Inviting " .. member.Name .. " to party")
                    local args = {"Invite", targetPlayer}
                    ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
                else
                    debugPrint("Could not find " .. member.Name .. " in server")
                end
            end)
        end
        inviteAttempts = inviteAttempts + 1
        
        -- Keep inviting every 3 seconds up to 6 attempts
        while inviteAttempts < maxInviteAttempts do
            debugPrint("Waiting 3 seconds before checking party status...")
            task.wait(3)
            
            if checkGroupMembersInParty(FARM_GROUP.Members) then
                debugPrint("All farm group members joined party successfully!")
                task.wait(1)
                return true
            end
            
            debugPrint("Not all members in party yet, sending invites again... (attempt " .. (inviteAttempts + 1) .. "/" .. maxInviteAttempts .. ")")
            -- Send invites again
            for _, member in pairs(FARM_GROUP.Members) do
                pcall(function()
                    local targetPlayer = Players:FindFirstChild(member.Name)
                    if targetPlayer then
                        local args = {"Invite", targetPlayer}
                        ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
                    end
                end)
            end
            inviteAttempts = inviteAttempts + 1
        end
        
        debugPrint("Max invite attempts reached for farm group")
        return false -- Max attempts reached
    end
    
    debugPrint("Player is not a leader, cannot invite members")
    return false -- Not a leader
end

local function acceptInvites()
    debugPrint("Attempting to accept invites...")
    local leaderName = nil
    
    for _, member in pairs(MAIN_GROUP.Members) do
        if localPlayer.Name == member.Name then
            leaderName = MAIN_GROUP.Leader.Name
            debugPrint("Player is main group member, will accept invites from " .. leaderName)
            break
        end
    end
    
    if not leaderName then
        for _, member in pairs(FARM_GROUP.Members) do
            if localPlayer.Name == member.Name then
                leaderName = FARM_GROUP.Leader.Name
                debugPrint("Player is farm group member, will accept invites from " .. leaderName)
                break
            end
        end
    end
    
    if leaderName then
        local maxAcceptAttempts = 6
        for i = 1, maxAcceptAttempts do
            debugPrint("Accept invite attempt " .. i .. "/" .. maxAcceptAttempts)
            pcall(function()
                local leaderPlayer = Players:FindFirstChild(leaderName)
                if leaderPlayer then
                    debugPrint("Found leader " .. leaderName .. ", sending accept invite")
                    local args = {"AcceptInvite", leaderPlayer}
                    ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
                else
                    debugPrint("Could not find leader " .. leaderName .. " in server")
                end
            end)
            
            -- Wait 5 seconds between attempts, except after the last attempt
            if i < maxAcceptAttempts then
                debugPrint("Waiting 5 seconds before next accept attempt...")
                task.wait(5)
            end
        end
    else
        debugPrint("Player is not a group member, no invites to accept")
    end
end

local function startQueue()
    debugPrint("Starting queue process...")
    
    if localPlayer.UserId == MAIN_GROUP.Leader.UserId or localPlayer.UserId == FARM_GROUP.Leader.UserId then
        debugPrint("Player is a leader, starting queue...")
        for attempt = 1, 8 do
            debugPrint("Queue attempt " .. attempt .. "/8")
            pcall(function()
                local args = {"JoinQueue", "CASCADE"}
                ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
            end)
            
            if attempt < 8 then
                task.wait(2)
            end
        end
        
        debugPrint("Waiting 5 seconds after initial queue attempts...")
        task.wait(5)
        
        if game.PlaceId == PLACE_MATCH then
            debugPrint("Still in match place, sending additional queue requests...")
            for attempt = 1, 4 do
                debugPrint("Additional queue attempt " .. attempt .. "/4")
                pcall(function()
                    local args = {"JoinQueue", "CASCADE"}
                    ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
                end)
                task.wait(3)
            end
        end
        
    elseif isMainGroupMember() or isFarmGroupMember() then
        debugPrint("Player is a group member, joining queue...")
        task.wait(2)
        for attempt = 1, 8 do
            debugPrint("Member queue attempt " .. attempt .. "/8")
            pcall(function()
                local args = {"JoinQueue", "CASCADE"}
                ReplicatedStorage.Remotes.Team:FireServer(unpack(args))
            end)
            if attempt < 8 then
                task.wait(2)
            end
        end
    else
        debugPrint("Player is not in any group, not joining queue")
    end
end

local function isMainGroupMember()
    if localPlayer.UserId == MAIN_GROUP.Leader.UserId then return true end
    for _, member in pairs(MAIN_GROUP.Members) do
        if localPlayer.UserId == member.UserId then return true end
    end
    return false
end

local function isFarmGroupMember()
    if localPlayer.UserId == FARM_GROUP.Leader.UserId then return true end
    for _, member in pairs(FARM_GROUP.Members) do
        if localPlayer.UserId == member.UserId then return true end
    end
    return false
end

-- PARTY LEAVE FUNCTION
local function leaveParty()
    debugPrint("Attempting to leave current party...")
    local success = pcall(function()
        local args = {"Leave"}
        ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Team"):FireServer(unpack(args))
    end)
    
    if success then
        debugPrint("Successfully sent leave party request")
    else
        debugPrint("Failed to send leave party request")
    end
end

local function leavePartyIfInOne()
    debugPrint("Checking if player is in a party and needs to leave...")
    
    -- Wait a bit for remotes to be ready
    local remotesReady = waitForRemotesReady()
    if not remotesReady then
        debugPrint("Remotes not ready, skipping party leave check")
        return
    end
    
    -- Check if we're in a party by trying to get party member IDs
    local partyMemberIds = getPartyMemberIds()
    if #partyMemberIds > 1 then -- More than just ourselves means we're in a party
        debugPrint("Player is in a party with " .. #partyMemberIds .. " members, leaving...")
        leaveParty()
        task.wait(2) -- Wait for leave to process
        
        -- Verify we left
        local newPartyMemberIds = getPartyMemberIds()
        if #newPartyMemberIds <= 1 then
            debugPrint("Successfully left party")
        else
            debugPrint("May still be in party, continuing anyway...")
        end
    elseif #partyMemberIds == 1 then
        debugPrint("Player is not in a party (solo)")
    else
        debugPrint("Could not determine party status")
    end
end

-- MAIN EXECUTION
local function runPartyManager()
    debugPrint("=== PARTY MANAGER STARTED ===")
    debugPrint("Player: " .. localPlayer.Name .. " (ID: " .. localPlayer.UserId .. ")")
    debugPrint("Current Place ID: " .. game.PlaceId)
    
    waitForGameLoaded()
    
    -- Leave any existing party at startup
    if game.PlaceId == PLACE_MATCH then
        debugPrint("In MATCH place, checking for existing party to leave...")
        leavePartyIfInOne()
    end
    
    local matchStartTime = tick()
    debugPrint("Match start time initialized: " .. matchStartTime)
    
    while true do
        if game.PlaceId == PLACE_MAIN then
            debugPrint("Currently in MAIN place, teleporting to MATCH...")
            safeTeleport(PLACE_MATCH)
            matchStartTime = tick() -- Reset timer on place change
            debugPrint("Reset match start time: " .. matchStartTime)
            
        elseif game.PlaceId == PLACE_MATCH then
            debugPrint("Currently in MATCH place")
            
            -- Check if no leader is in server and try to join one
            if not isLeaderInServer() then
                debugPrint("No leader in server, attempting to join leader...")
                tryJoinLeaderServer()
            end
            
            -- Wait for all accounts to be in server, with timeout
            debugPrint("Waiting for all accounts to be in server...")
            local waitingForAccounts = true
            while waitingForAccounts do
                local elapsed = tick() - matchStartTime
                debugPrint("Time elapsed: " .. math.floor(elapsed) .. " seconds (timeout at 300s)")
                
                if elapsed > 300 then
                    debugPrint("Timeout reached (300s), teleporting to MAIN")
                    safeTeleport(PLACE_MAIN)
                    matchStartTime = tick()
                    break
                end
                
                if allAccountsInServer() then
                    debugPrint("All accounts are in server! Proceeding...")
                    waitingForAccounts = false
                    local remotesReady = waitForRemotesReady()
                    
                    if remotesReady then
                        debugPrint("Waiting 3 seconds before party operations...")
                        task.wait(3)
                        
                        -- For leaders: invite and wait for members to join party
                        if localPlayer.UserId == MAIN_GROUP.Leader.UserId or localPlayer.UserId == FARM_GROUP.Leader.UserId then
                            debugPrint("Player is a leader, managing party...")
                            local partyReady = inviteAndWaitForMembers()
                            if partyReady then
                                debugPrint("Party is ready, starting queue...")
                                startQueue()
                                debugPrint("Waiting 10 seconds after queue start...")
                                task.wait(10)
                            else
                                debugPrint("Party setup failed")
                            end
                        else
                            -- For members: accept invites
                            debugPrint("Player is a member, accepting invites and joining queue...")
                            acceptInvites()
                            startQueue()
                            debugPrint("Waiting 10 seconds after queue join...")
                            task.wait(10)
                        end
                    else
                        debugPrint("Remotes not ready, skipping party operations")
                    end
                else
                    debugPrint("Not all accounts in server yet, waiting 15 seconds...")
                    task.wait(15)
                end
            end
            
        elseif game.PlaceId == PLACE_CASCADE then
            debugPrint("Currently in CASCADE place")
            
            -- Check if server contains only specified accounts
            if not serverHasOnlySpecifiedAccounts() then
                -- If server has players that aren't in our account list, teleport immediately
                debugPrint("Server has non-specified accounts, teleporting to MATCH immediately")
                safeTeleport(PLACE_MATCH)
                matchStartTime = tick()
            else
                -- Original logic if server only has specified accounts
                debugPrint("Server has only specified accounts, proceeding with normal logic")
                debugPrint("Waiting 5 seconds...")
                task.wait(5)
                
                if isFarmGroupMember() then
                    debugPrint("Player is farm group member, teleporting to MATCH")
                    safeTeleport(PLACE_MATCH)
                    matchStartTime = tick()
                end
                
                debugPrint("Waiting 10 seconds...")
                task.wait(20)
                
                if isMainGroupMember() then
                    debugPrint("Player is main group member, teleporting to MATCH")
                    safeTeleport(PLACE_MATCH)
                    matchStartTime = tick()
                end
            end
        else
            debugPrint("Unknown place ID: " .. game.PlaceId .. ", waiting...")
        end
        
        task.wait(1)
    end
end

-- START SCRIPT
debugPrint("Spawning party manager...")
spawn(runPartyManager)
