-- SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local localPlayer = Players.LocalPlayer

-- Wait for game to load
if not game:IsLoaded() then
    game.Loaded:Wait()
end

-- Wait for chat system
local function waitForChatSystemReady()
    local attempts = 0
    while attempts < 30 do
        attempts = attempts + 1
        
        local success = pcall(function()
            ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents", 1)
            ReplicatedStorage.DefaultChatSystemChatEvents:WaitForChild("SayMessageRequest", 1)
            return true
        end)
        
        if success then
            return true
        end
        
        task.wait(1)
    end
    
    return false
end

-- Get random player (not yourself)
local function getRandomPlayer()
    local players = {}
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer then
            table.insert(players, player)
        end
    end
    
    if #players > 0 then
        return players[math.random(1, #players)]
    end
    return nil
end

-- Test whisper function
local function testWhisper()
    if not waitForChatSystemReady() then
        return
    end
    
    local randomPlayer = getRandomPlayer()
    if not randomPlayer then
        return
    end
    
    -- Test 3 whisper attempts
    for attempt = 1, 3 do
        -- Get a random player each time
        randomPlayer = getRandomPlayer()
        if randomPlayer then
            pcall(function()
                local message = "/whisper " .. randomPlayer.Name .. " !joinserver TestLeader"
                
                local args = {
                    [1] = message
                }
                ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(unpack(args))
            end)
        end
        
        -- Wait 10 seconds between attempts (except after last one)
        if attempt < 3 then
            task.wait(10)
        end
    end
end

-- Run the test
testWhisper()
